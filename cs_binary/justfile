set dotenv-load := true

PROJECT_NAME := "cs_binary"
OUTPUT_DIR := "publish"
MODELS_DIR := "Models"

@default:
    @just --list

# Build for current platform
@build:
    dotnet build -c Release

# Build and publish for current platform
@publish:
    dotnet publish -c Release -o {{OUTPUT_DIR}}

# Copy ONNX models to output directory
@copy-models:
    #!/usr/bin/env bash
    set -e
    mkdir -p {{OUTPUT_DIR}}/{{MODELS_DIR}}
    cp -r {{MODELS_DIR}}/* {{OUTPUT_DIR}}/{{MODELS_DIR}}/
    echo "Models copied to {{OUTPUT_DIR}}/{{MODELS_DIR}}"

# Full build: build, publish, copy models
@full-build: publish copy-models
    echo "Build complete for current platform"

# Build for Windows x64
@build-win-x64:
    dotnet publish -c Release -r win-x64 -o {{OUTPUT_DIR}}-win-x64

# Build for Windows arm64
@build-win-arm64:
    dotnet publish -c Release -r win-arm64 -o {{OUTPUT_DIR}}-win-arm64

# Build for macOS x64
@build-macos-x64:
    dotnet publish -c Release -r osx-x64 -o {{OUTPUT_DIR}}-osx-x64

# Build for macOS arm64 (Apple Silicon)
@build-macos-arm64:
    dotnet publish -c Release -r osx-arm64 -o {{OUTPUT_DIR}}-osx-arm64

# Build for Linux x64
@build-linux-x64:
    dotnet publish -c Release -r linux-x64 -o {{OUTPUT_DIR}}-linux-x64

# Build for Linux arm64
@build-linux-arm64:
    dotnet publish -c Release -r linux-arm64 -o {{OUTPUT_DIR}}-linux-arm64

# Build for Linux arm
@build-linux-arm:
    dotnet publish -c Release -r linux-arm -o {{OUTPUT_DIR}}-linux-arm

# Copy models to a release directory
@copy-models-to target:
    #!/usr/bin/env bash
    set -e
    mkdir -p {{target}}/{{MODELS_DIR}}
    cp -r {{MODELS_DIR}}/* {{target}}/{{MODELS_DIR}}/
    echo "Models copied to {{target}}/{{MODELS_DIR}}"

# Build all platforms
@build-all: build-all-win build-all-macos build-all-linux
    echo "All platforms built successfully"

# Build all Windows targets
@build-all-win: build-win-x64 build-win-arm64
    echo "Windows builds complete"

# Build all macOS targets
@build-all-macos: build-macos-x64 build-macos-arm64
    echo "macOS builds complete"

# Build all Linux targets
@build-all-linux: build-linux-x64 build-linux-arm64 build-linux-arm
    echo "Linux builds complete"

# Create release package for Windows x64
@release-win-x64: build-win-x64
    just copy-models-to {{OUTPUT_DIR}}-win-x64
    cd {{OUTPUT_DIR}}-win-x64 && rm -f *.dylib *.so && zip -r ../{{PROJECT_NAME}}-win-x64.zip *
    echo "Created {{PROJECT_NAME}}-win-x64.zip"

# Create release package for Windows arm64
@release-win-arm64: build-win-arm64
    just copy-models-to {{OUTPUT_DIR}}-win-arm64
    cd {{OUTPUT_DIR}}-win-arm64 && rm -f *.dylib *.so && zip -r ../{{PROJECT_NAME}}-win-arm64.zip *
    echo "Created {{PROJECT_NAME}}-win-arm64.zip"

# Create release package for macOS x64
@release-macos-x64: build-macos-x64
    just copy-models-to {{OUTPUT_DIR}}-osx-x64
    cd {{OUTPUT_DIR}}-osx-x64 && rm -f *.dll && zip -r ../{{PROJECT_NAME}}-osx-x64.zip *
    echo "Created {{PROJECT_NAME}}-osx-x64.zip"

# Create release package for macOS arm64
@release-macos-arm64: build-macos-arm64
    just copy-models-to {{OUTPUT_DIR}}-osx-arm64
    cd {{OUTPUT_DIR}}-osx-arm64 && rm -f *.dll && zip -r ../{{PROJECT_NAME}}-osx-arm64.zip *
    echo "Created {{PROJECT_NAME}}-osx-arm64.zip"

# Create release package for Linux x64
@release-linux-x64: build-linux-x64
    just copy-models-to {{OUTPUT_DIR}}-linux-x64
    cd {{OUTPUT_DIR}}-linux-x64 && rm -f *.dll *.dylib && tar -czf ../{{PROJECT_NAME}}-linux-x64.tar.gz .
    echo "Created {{PROJECT_NAME}}-linux-x64.tar.gz"

# Create release package for Linux arm64
@release-linux-arm64: build-linux-arm64
    just copy-models-to {{OUTPUT_DIR}}-linux-arm64
    cd {{OUTPUT_DIR}}-linux-arm64 && rm -f *.dll *.dylib && tar -czf ../{{PROJECT_NAME}}-linux-arm64.tar.gz .
    echo "Created {{PROJECT_NAME}}-linux-arm64.tar.gz"

# Create release package for Linux arm
@release-linux-arm: build-linux-arm
    just copy-models-to {{OUTPUT_DIR}}-linux-arm
    cd {{OUTPUT_DIR}}-linux-arm && rm -f *.dll *.dylib && tar -czf ../{{PROJECT_NAME}}-linux-arm.tar.gz .
    echo "Created {{PROJECT_NAME}}-linux-arm.tar.gz"

# Create all release packages
@release-all: release-all-win release-all-macos release-all-linux
    echo "All release packages created"

# Create all Windows release packages
@release-all-win: release-win-x64 release-win-arm64
    echo "Windows releases complete"

# Create all macOS release packages
@release-all-macos: release-macos-x64 release-macos-arm64
    echo "macOS releases complete"

# Create all Linux release packages
@release-all-linux: release-linux-x64 release-linux-arm64 release-linux-arm
    echo "Linux releases complete"

# Clean build artifacts
@clean:
    dotnet clean -c Release
    rm -rf {{OUTPUT_DIR}}*
    rm -rf bin obj
    echo "Cleaned build artifacts"

# Run tests (if any)
@test:
    dotnet test

# Restore NuGet packages
@restore:
    dotnet restore

# Show build information
@info:
    @echo "Project: {{PROJECT_NAME}}"
    @echo "Output: {{OUTPUT_DIR}}"
    @echo "Models: {{MODELS_DIR}}"
    @dotnet --version

# Install native messaging host
@install extension_id:
    ./{{OUTPUT_DIR}}/{{PROJECT_NAME}} --install {{extension_id}}

# Test the classifier
@test-classify text:
    #!/usr/bin/env python3
    import struct
    import json
    import subprocess
    import sys
    
    msg = json.dumps({'type': 'classify_text', 'text': '{{text}}'})
    msg_bytes = msg.encode('utf-8')
    length_prefix = struct.pack('<I', len(msg_bytes))
    
    proc = subprocess.Popen('./{{OUTPUT_DIR}}/{{PROJECT_NAME}}', stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    stdout, stderr = proc.communicate(length_prefix + msg_bytes)
    
    response_len = struct.unpack('<I', stdout[:4])[0]
    response = stdout[4:4+response_len].decode('utf-8')
    print(response)
